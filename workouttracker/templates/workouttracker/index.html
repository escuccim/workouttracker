{% extends 'workouttracker/base.html' %}
{% load dict_key %}
{% load index %}

{% block body %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Workout Tracker : {{ user.first_name }}</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <form class="form form-horizontal" id="controller">
                <div class="panel panel-default">

                    <div class="row">
                        <label class="control-label col-md-1" for="start_date">Start:</label>
                        <div class="col-md-2">
                            <input class="form-control" id="start_date" name="start_date" type="date" value="{{ start_date }}">
                        </div>

                        <label class="control-label col-md-1" for="end_date">End:</label>
                        <div class="col-md-2">
                            <input class="form-control" id="end_date" name="end_date" type="date" value="{{ end_date }}">
                        </div>

                        <label class="control-label col-md-1" for="chart">Chart:</label>
                        <div class="col-md-2">
                            <select class="form-control" id="chart" name="chart">
                                <option value="summary">Summary</option>
                                <option value="breakdown">Breakdown by Group</option>
                            </select>
                        </div>

                        <div class="col-md-1">
                            <button type="submit" class="btn btn-action btn-sm">Update</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="summary_chart" style="display: block;">
                <canvas id="SummaryChart" width="400" height="150"></canvas>
            </div>
            <div id="breakdown_chart" style="display: none;">
                <canvas id="BreakdownChart" width="400" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="panel-group" id="accordion">
                {% for date in dates %}
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" href="#{{date}}">
                                    <div class="row">
                                        <div class="col-md-2">
                                            {{ date }}
                                        </div>
                                        <div class="col-md-2">
                                            {{ minutes|index:forloop.counter0 }} mins
                                        </div>
                                        <div class="col-md-2">
                                            {{ calories|index:forloop.counter0 }} kCal
                                        </div>
                                    </div>
                                </a>
                            </h4>
                        </div>
                        <div id="{{date}}" class="panel-collapse collapse">
                            <div class="panel-body">
                                {% for workout in workouts|dict_key:date %}
                                    <div class="row">
                                        <div class="col-md-3">
                                            {{ workout.start }}
                                        </div>
                                        <div class="col-md-2">
                                            {{ workout.group.name }}
                                        </div>
                                        <div class="col-md-2">
                                            {{ workout.duration }} mins
                                        </div>
                                        <div class="col-md-2">
                                            {{ workout.calories }} kCal
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>
<script>
$("#controller").on("submit", function(e){
    e.preventDefault();
    start_date = $("#start_date").val();
    end_date = $("#end_date").val();

    chart = $("#chart").val();

    if(chart == "summary"){
        summary_chart(ctx, myChart, start_date, end_date);
    } else if(chart == "breakdown"){
        breakdown_chart(ctx, myChart, start_date, end_date);
    }
});

function get_chart_data(url){
    var data;
    $.ajax({
        async: false,
        url: url,
        type: 'get',
        success: function(result){
            data = result;
        },
        error: function(){
            console.log("Error!");
        }
        });
    return data;
}

var ctx = document.getElementById("SummaryChart").getContext('2d');
var myChart;

function summary_chart(ctx, myChart, start_date, end_date){
    url = "api/chart_data?foo=bar";
    if(start_date != undefined){
        url += "&start=" + start_date;
    }
    if(end_date != undefined) {
        url += "&end=" + end_date;
    }
    data = get_chart_data(url);

    try {
        myChart.destroy();
    } catch(err) {
        // do nothing
    }

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Calories',
                data: data.calories,
                label: 'kCal',
                yAxisID: 'A',
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                ],
                borderColor: [
                    'rgba(255,99,132,1)',
                ],
                borderWidth: 1
            },{
                label: 'Minutes',
                data: data.minutes,
                label: 'min',
                yAxisID: 'B',
                backgroundColor: [
                    'rgba(132, 99, 255, 0.2)',
                ],
                borderColor: [
                    'rgba(132,99,255,1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
              yAxes: [{
                id: 'A',
                type: 'linear',
                position: 'left',
              }, {
                id: 'B',
                type: 'linear',
                position: 'right',
              }]
            }
        }
    });

    return myChart;
}

function breakdown_chart(ctx, myChart, start_date, end_date){
    url = "api/breakdown?foo";
    if(start_date != undefined){
        url += "&start=" + start_date;
    }
    if(end_date != undefined) {
        url += "&end=" + end_date;
    }
    data = get_chart_data(url);

    try {
        myChart.destroy();
    } catch(err) {
        // do nothing
    }

    data = get_chart_data(url);

    try {
        myChart.destroy();
    } catch(err) {
        // do nothing
    }

    // create the datasets
    datasets = []
    for(var i=0; i < data.groups.length; i++){
       group = {
            label: data.groups[i],
            data: data.data[data.groups[i]].minutes,
            yAxisID: 'A',
            borderWidth: 1,
            backgroundColor: data.data[data.groups[i]].color,
       }
       datasets.push(group);
    }

    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: datasets,
        },
        options: {
            scales: {
              yAxes: [{
                id: 'A',
                type: 'linear',
                position: 'left',
                stacked: true,
              }],
              xAxes: [{
                stacked: true,
              }]
            }
        }
    });

    return myChart;
}

var myChart = summary_chart(ctx, myChart);

</script>
{% endblock %}